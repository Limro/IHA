\documentclass[Aflevering]{subfiles}
\begin{document}


\subsection{Analyse og optimering}

Optimering af projektet har været i fokus, men er ikke vægtet i samme grad, som andre punkter.
Dette viser sig i Quartus' analyse af projektet, hvor forholdet mellem registre og logiske elementer ikke er 1:1.
Der er totalt 23.272 logiske elementer og 13.549 registre.
Langt størstedelen af alle disse registre kommer fra de to \textit{RamAccess}-moduler, som hver i sær har 5911 registre, hvorimod \textit{TransferProtocol} har 59, mens \textit{PlaySound} har 66.
\\
\\
Quartus vil desværre ikke op til afleveringsfristen vise hvad \textit{fmax} er, hvilket er en skam, da dette fortæller hvor høj frekvens systemet maksimalt vil kunne køre med.
\\
\\
I bund og grund ville det heller ikke give alt for meget mening at gå ned og optimere meget i VHDL-koden idet vi har valgt at skrive store dele af vores projekt i C som langt fra er så hurtigt som hvis man gjorde det direkte i VHDL. 
Herunder bl.a. også at vi vælger at bruge \textit{math}-bibliotekets sinus-funktion hver gang en ny frekvens findes frem for at gemme det i en LUT. 
Se mere herom under \ref{sec:LUT}






\subsection{Test og simulering}
For at sikre, at VHDL-koden virker som ønsket, er koden testet med programmet ModelSim 10.1b, hvor hvert komponent er unittestet samt en integreringstest for 2 af komponenterne.

Koden er testet således, at alle kodelinjer er blevet afprøvet, så der ikke er en linje der vil sende underlig data ud.
Ligeledes er der testet flere scenarier, hvor forskellige værdier sendes til og fra de forskellige komponenter.

Grundet den mængde af data der sendes til ram-modulerne, for hver frekvens der ønskes afspillet, er der ikke testet nær det antal der vil sendes over ved normal kørsel af systemet, men blot enkelte, sekventielle værdier, således selve processen er vist testet.
Hvis man ønskede at teste for, at alle værdier ville blive skrevet korrekt over, vil det tage meget lang tid at verificere, bedst illustreret på figur \ref{fig:hz-graf}.
\[
\text{antal samples} = \frac{\text{48000 Hz}}{\text{ønsket frekvens}}
\]

\begin{figure}[hbtp]
\centering
\includegraphics[scale=1]{hz-graf}
\caption{Mængden af data der skal overføres (y-akse) for en frekvens (x-akse)}
\label{fig:hz-graf}
\end{figure}


Første test er af komponentet \textit{TransportProtocol}, der står for overførelsen af data fra microcontrolleren til ram-modulerne.
På figur \ref{fig:TP}\footnote{Se også appendix \ref{app:wave-TP}} ses et wave-udsnit af \textit{TransportProtocol}'s testbench:

\begin{figure}[hbtp]
\centering
\includegraphics[scale=0.65]{tb-wave-TP}
\caption{Waveforms for \textit{TransportProtocol}}
\label{fig:TP}
\end{figure}


På figur \ref{fig:TP} foretages der først et reset af komponentet (0-50 ns), hvorefter der skrives hvor mange samples der kommer (60-70 ns), værdierne skrives med 10 ns mellemrum (70-100 ns), hvilket også er vist i appendix \ref{app:TP}.
Ved 95 ns bliver den sidste værdi overført og det angives hvor mange samples der er overført.
Alt dette skrives til \textit{ram\_cs\_module0}.


Efter 160 ns aktiveres \textit{CS} igen og der skrives én ny værdi til ram-modulet. 
Denne skrives til \textit{ram\_cs\_module1}, hvor \textit{ram\_cs\_module0} er deaktiveret.



Der testes ligeledes også når der ikke sendes værdier over -- altså hvor der ikke skal afspilles noget.
\\
\\
Komponentet \textit{RamAccess} lagrer de overførte værdier. 

\begin{figure}[hbtp]
\centering
\includegraphics[scale=1]{tb-wave-RA}
\caption{Waveforms for \textit{RamAccess}}
\label{fig:RA}
\end{figure}

På figur \ref{fig:RA}\footnote{Se og appendix \ref{app:wave-RA}} foretages der først et reset på 50 ns, chipselect aktiveres og der skrives til adresse 0 med værdien 3 (60-70 ns).
Herefter skrives til adresse 1 med værdien 1 (70-90 ns) og fordi \textit{readAddress} ikke ændres, læses værdien fra adresse 0 ud (75-95 ns). 
Dette vises også i \ref{app:RA}.
Læsningsprocessen gentages fra 95 ns og frem.
\\
\\
Komponentet \textit{PlaySound} er en smule mere omfattende og det testes sammen med \textit{Ram\-Access} for at opnå det bedste resultat.

\begin{figure}[hbtp]
\centering
\includegraphics[scale=0.65]{tb-wave-PSandRA}
\caption{Waveforms for \textit{Playsound} og \textit{RamAccess}}
\label{fig:PSandRA}
\end{figure}

Den viste sekvens på figur \ref{fig:PSandRA}\footnote{Se og appendix \ref{app:wave-PS}} er på 3,5 microsekunder.
Først foretages et reset, for at nulstille alle værdier (0-250 ns), hvorefter der skrives nogle dummy-værdier ind i de to ram-moduler (270-350 ns).
Herefter vælges læsning fra ram-modul1 (250-620 ns) og værdierne læses og genlæses indtil ram-modul0 vælges (620-2.170 ns).
Det nye antal af værdier der skal læses bliver herefter læst ind (2.170-3.500 ns).

Overstående tests viser, at der kan læses fra \textit{RamAccess} når der ligger data deri, samt \textit{PlaySound} kun afspiller det den bliver bedt om igen og igen.
Derudover kan der skrives i \textit{TransportProtocol} og videresendes data om både hvor mange samples der skal afspilles, samt hvilket ram-modul der skrives på og skal læses fra.



\end{document}